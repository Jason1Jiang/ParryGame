# æˆ˜æ–—æ— æ•Œä¼˜åŒ– v3.7 - å®ç°å®Œæˆ

## å®ç°æ—¥æœŸ
2024-12-19

## åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®ç°æˆ˜æ–—æ— æ•Œç³»ç»Ÿï¼Œåœ¨ç©å®¶æ‰§è¡Œåå‡»åŠ¨ä½œæœŸé—´æä¾›æ— æ•Œä¿æŠ¤ï¼Œé¿å…åœ¨åå‡»è¿‡ç¨‹ä¸­è¢«å…¶ä»–æ•Œäººå‡»ä¸­ï¼Œæå‡æˆ˜æ–—æµç•…åº¦å’Œå…¬å¹³æ€§ã€‚

---

## å®ç°å†…å®¹

### 1. æ ¸å¿ƒç³»ç»Ÿ

#### æ— æ•ŒçŠ¶æ€å˜é‡
```javascript
// æ— æ•ŒçŠ¶æ€ç³»ç»Ÿ
let playerInvincible = false;      // æ˜¯å¦æ— æ•Œ
let invincibleEndTime = 0;         // æ— æ•Œç»“æŸæ—¶é—´
let invincibleReason = null;       // æ— æ•ŒåŸå› ï¼ˆç”¨äºè°ƒè¯•ï¼‰
```

#### æ ¸å¿ƒå‡½æ•°

**æ£€æŸ¥æ— æ•ŒçŠ¶æ€**
```javascript
function isPlayerInvincible() {
    if (!playerInvincible) return false;
    
    const now = Date.now();
    if (now >= invincibleEndTime) {
        playerInvincible = false;
        invincibleReason = null;
        return false;
    }
    
    return true;
}
```

**è®¾ç½®æ— æ•ŒçŠ¶æ€**
```javascript
function setPlayerInvincible(duration, reason = 'unknown') {
    playerInvincible = true;
    invincibleEndTime = Date.now() + duration;
    invincibleReason = reason;
    
    const invCfg = CONFIG.invincibility;
    if (invCfg?.debug?.enabled && invCfg?.debug?.showInConsole) {
        console.log(`Player invincible: ${reason}, duration: ${duration}ms`);
    }
}
```

**æ¸…é™¤æ— æ•ŒçŠ¶æ€**
```javascript
function clearPlayerInvincible() {
    playerInvincible = false;
    invincibleEndTime = 0;
    invincibleReason = null;
}
```

---

### 2. é›†æˆç‚¹

#### é›†æˆç‚¹1ï¼šå•æ¬¡åå‡»æ— æ•Œ
åœ¨ `triggerCounter()` å‡½æ•°ä¸­ï¼Œå½“è§¦å‘å•æ¬¡åå‡»æ—¶è®¾ç½®æ— æ•Œï¼š

```javascript
// è®¾ç½®å•æ¬¡åå‡»æ— æ•ŒçŠ¶æ€ï¼ˆä»…åœ¨éå¤šé‡åå‡»æ—¶ï¼‰
if (!multiCounterActive) {
    const invCfg = CONFIG.invincibility;
    if (invCfg?.enabled && invCfg?.counter?.enabled) {
        const duration = invCfg.counter.duration + invCfg.counter.bufferTime;
        setPlayerInvincible(duration, 'counter');
    }
}
```

**æ—¶é•¿è®¡ç®—**ï¼š
- åå‡»åŠ¨ç”»ï¼š500ms
- ç¼“å†²æ—¶é—´ï¼š200ms
- æ€»è®¡ï¼š700ms

#### é›†æˆç‚¹2ï¼šå¤šé‡åå‡»æ— æ•Œ
åœ¨ `triggerMultiCounter()` å‡½æ•°ä¸­ï¼Œå½“è§¦å‘å¤šé‡åå‡»æ—¶è®¾ç½®æ— æ•Œï¼š

```javascript
// è®¾ç½®å¤šé‡åå‡»æ— æ•ŒçŠ¶æ€
const invCfg = CONFIG.invincibility;
if (invCfg?.enabled && invCfg?.multiCounter?.enabled) {
    const perCounterDuration = invCfg.multiCounter.perCounterDuration;
    const delayBetween = invCfg.multiCounter.delayBetweenCounters;
    const bufferTime = invCfg.multiCounter.bufferTime;
    const totalDuration = targets.length * (perCounterDuration + delayBetween) + bufferTime;
    setPlayerInvincible(totalDuration, 'multi-counter');
}
```

**æ—¶é•¿è®¡ç®—**ï¼ˆä»¥3ä¸ªæ•Œäººä¸ºä¾‹ï¼‰ï¼š
- æ¯æ¬¡åå‡»ï¼š500ms
- åå‡»é—´éš”ï¼š200ms
- ç¼“å†²æ—¶é—´ï¼š300ms
- æ€»è®¡ï¼š3 Ã— (500 + 200) + 300 = 2400ms

#### é›†æˆç‚¹3ï¼šè¿‘æˆ˜æ•Œäººç¢°æ’æ£€æµ‹
åœ¨è¿‘æˆ˜æ•Œäººçš„æ”»å‡»æ£€æµ‹ä¸­æ·»åŠ æ— æ•Œæ£€æŸ¥ï¼š

```javascript
if (checkMeleeHit(enemy)) {
    // æ£€æŸ¥ç©å®¶æ˜¯å¦æ— æ•Œ
    if (isPlayerInvincible()) {
        // æ— æ•ŒæœŸé—´ä¸å—ä¼¤å®³
        break;
    }
    
    if (player.blocking && !player.counterAttacking) {
        // ... æ ¼æŒ¡é€»è¾‘
    }
}
```

#### é›†æˆç‚¹4ï¼šå­å¼¹ç¢°æ’æ£€æµ‹
åœ¨å­å¼¹ç¢°æ’æ£€æµ‹ä¸­æ·»åŠ æ— æ•Œæ£€æŸ¥ï¼š

```javascript
if (dist < player.radius + bullet.radius) {
    // æ£€æŸ¥ç©å®¶æ˜¯å¦æ— æ•Œ
    if (isPlayerInvincible()) {
        // æ— æ•ŒæœŸé—´ä¸å—ä¼¤å®³ï¼Œå­å¼¹ç›´æ¥ç©¿è¿‡
        continue;
    }
    
    if (player.blocking && !player.counterAttacking) {
        // ... æ ¼æŒ¡é€»è¾‘
    }
}
```

#### é›†æˆç‚¹5ï¼šæ¸¸æˆé‡ç½®
åœ¨æ¸¸æˆé‡æ–°å¼€å§‹æ—¶æ¸…é™¤æ— æ•ŒçŠ¶æ€ï¼š

```javascript
// é‡ç½®æ— æ•ŒçŠ¶æ€
playerInvincible = false;
invincibleEndTime = 0;
invincibleReason = null;
```

---

### 3. é…ç½®å‚æ•°

åœ¨ `config.json` ä¸­æ·»åŠ äº†å®Œæ•´çš„æ— æ•Œé…ç½®ï¼š

```json
"invincibility": {
  "enabled": true,
  "counter": {
    "enabled": true,
    "duration": 500,
    "bufferTime": 200
  },
  "multiCounter": {
    "enabled": true,
    "perCounterDuration": 500,
    "delayBetweenCounters": 200,
    "bufferTime": 300
  },
  "debug": {
    "enabled": false,
    "showInConsole": false
  }
}
```

**å‚æ•°è¯´æ˜**ï¼š

- **enabled**: æ€»å¼€å…³ï¼Œæ§åˆ¶æ•´ä¸ªæ— æ•Œç³»ç»Ÿ
- **counter.enabled**: å•æ¬¡åå‡»æ— æ•Œå¼€å…³
- **counter.duration**: å•æ¬¡åå‡»åŠ¨ç”»æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
- **counter.bufferTime**: å•æ¬¡åå‡»åçš„ç¼“å†²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- **multiCounter.enabled**: å¤šé‡åå‡»æ— æ•Œå¼€å…³
- **multiCounter.perCounterDuration**: æ¯æ¬¡åå‡»çš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
- **multiCounter.delayBetweenCounters**: åå‡»ä¹‹é—´çš„é—´éš”ï¼ˆæ¯«ç§’ï¼‰
- **multiCounter.bufferTime**: æ‰€æœ‰åå‡»å®Œæˆåçš„ç¼“å†²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- **debug.enabled**: è°ƒè¯•æ¨¡å¼å¼€å…³
- **debug.showInConsole**: æ˜¯å¦åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ— æ•ŒçŠ¶æ€

---

## å®ç°ç‰¹ç‚¹

### 1. æ— è§†è§‰è¡¨ç°
âœ… æ— æ•ŒçŠ¶æ€å®Œå…¨åœ¨åå°è¿è¡Œ  
âœ… ç©å®¶ä¸ä¼šçœ‹åˆ°ä»»ä½•æ— æ•Œæç¤º  
âœ… ä¿æŒæ¸¸æˆè§†è§‰çš„ç®€æ´æ€§  
âœ… ä¸å½±å“æ¸¸æˆç”»é¢

### 2. ç²¾ç¡®æ—¶é—´æ§åˆ¶
âœ… ä½¿ç”¨ `Date.now()` è€Œéå¸§è®¡æ•°  
âœ… ç¡®ä¿æ—¶é—´ç²¾ç¡®  
âœ… é¿å…å¸§ç‡æ³¢åŠ¨å½±å“  
âœ… è‡ªåŠ¨è¿‡æœŸæœºåˆ¶

### 3. ç¢°æ’æ£€æµ‹ä¼˜å…ˆçº§
âœ… åœ¨ç¢°æ’æ£€æµ‹çš„æœ€å¼€å§‹æ£€æŸ¥æ— æ•Œ  
âœ… æ— æ•ŒæœŸé—´ç›´æ¥è·³è¿‡ä¼¤å®³åˆ¤å®š  
âœ… ä¸å½±å“å…¶ä»–æ¸¸æˆé€»è¾‘  
âœ… æ€§èƒ½å¼€é”€æå°

### 4. çŠ¶æ€æ¸…ç†
âœ… æ¸¸æˆé‡ç½®æ—¶æ¸…é™¤æ— æ•ŒçŠ¶æ€  
âœ… æ— æ•Œæ—¶é—´åˆ°æœŸè‡ªåŠ¨æ¸…é™¤  
âœ… é˜²æ­¢çŠ¶æ€æ®‹ç•™  
âœ… ç¡®ä¿æ¸¸æˆæ­£å¸¸è¿è¡Œ

### 5. è°ƒè¯•æ”¯æŒ
âœ… å¯é€‰çš„è°ƒè¯•æ¨¡å¼  
âœ… æ§åˆ¶å°è¾“å‡ºæ— æ•ŒçŠ¶æ€  
âœ… æ˜¾ç¤ºæ— æ•ŒåŸå› å’Œæ—¶é•¿  
âœ… æ–¹ä¾¿æµ‹è¯•å’Œè°ƒæ•´

---

## æ—¶é—´è½´ç¤ºä¾‹

### å•æ¬¡åå‡»
```
0ms     - æ ¼æŒ¡æˆåŠŸ
0ms     - è®¾ç½®æ— æ•Œï¼ˆ700msï¼‰
0-500ms - åå‡»åŠ¨ç”»ï¼ˆç¬ç§»+å‡»æ€ï¼‰
500ms   - åå‡»å®Œæˆ
500-700ms - ç¼“å†²æœŸï¼ˆä»ç„¶æ— æ•Œï¼‰
700ms   - æ— æ•Œç»“æŸ

æ€»æ— æ•Œæ—¶é•¿ï¼š700ms
```

### å¤šé‡åå‡»ï¼ˆ3ä¸ªæ•Œäººï¼‰
```
0ms       - å®Œç¾æ ¼æŒ¡æˆåŠŸ
0ms       - è®¾ç½®æ— æ•Œï¼ˆ2400msï¼‰
0-500ms   - åå‡»æ•Œäºº1
500-700ms - é—´éš”
700-1200ms - åå‡»æ•Œäºº2
1200-1400ms - é—´éš”
1400-1900ms - åå‡»æ•Œäºº3
1900ms    - æ‰€æœ‰åå‡»å®Œæˆ
1900-2400ms - ç¼“å†²æœŸï¼ˆä»ç„¶æ— æ•Œï¼‰
2400ms    - æ— æ•Œç»“æŸ

æ€»æ— æ•Œæ—¶é•¿ï¼š2400ms
```

---

## æµ‹è¯•å»ºè®®

### æµ‹è¯•1ï¼šå•æ¬¡åå‡»ä¿æŠ¤
1. å¼€å§‹æ¸¸æˆ
2. ç­‰å¾…æ•Œäººæ¥è¿‘
3. æ ¼æŒ¡æˆåŠŸï¼Œè§¦å‘åå‡»
4. è§‚å¯Ÿåå‡»è¿‡ç¨‹ä¸­æ˜¯å¦ä¼šè¢«å…¶ä»–æ•Œäººå‡»ä¸­

**é¢„æœŸç»“æœ**ï¼š
- âœ… åå‡»æœŸé—´ä¸ä¼šè¢«å‡»ä¸­
- âœ… åå‡»å®ŒæˆåçŸ­æš‚æ—¶é—´å†…ä¸ä¼šè¢«å‡»ä¸­
- âœ… ç¼“å†²æœŸç»“æŸåå¯ä»¥æ­£å¸¸è¢«å‡»ä¸­

### æµ‹è¯•2ï¼šå¤šé‡åå‡»ä¿æŠ¤
1. å¼€å§‹æ¸¸æˆï¼ˆç¡¬æ ¸éš¾åº¦ï¼Œæ•Œäººå¤šï¼‰
2. ç­‰å¾…å¤šä¸ªæ•Œäººæ¥è¿‘
3. å®Œç¾æ ¼æŒ¡ï¼Œè§¦å‘å¤šé‡åå‡»
4. è§‚å¯Ÿæ•´ä¸ªå¤šé‡åå‡»é“¾æ˜¯å¦ä¼šè¢«æ‰“æ–­

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ•´ä¸ªå¤šé‡åå‡»é“¾ä¸ä¼šè¢«æ‰“æ–­
- âœ… å¯ä»¥å®Œæ•´å‡»æ€æ‰€æœ‰ç›®æ ‡
- âœ… åå‡»å®Œæˆåæœ‰ç¼“å†²æ—¶é—´

### æµ‹è¯•3ï¼šç¼“å†²æœŸä¿æŠ¤
1. å¼€å§‹æ¸¸æˆ
2. æ ¼æŒ¡åå‡»ä¸€ä¸ªæ•Œäºº
3. åå‡»å®Œæˆç¬é—´ï¼Œè§‚å¯Ÿæ˜¯å¦ç«‹å³è¢«å‡»ä¸­

**é¢„æœŸç»“æœ**ï¼š
- âœ… åå‡»å®Œæˆåæœ‰çŸ­æš‚ç¼“å†²
- âœ… ä¸ä¼šç«‹å³è¢«å‡»ä¸­
- âœ… ç¼“å†²æœŸåæ­£å¸¸å—ä¼¤

### æµ‹è¯•4ï¼šæ— è§†è§‰è¡¨ç°
1. å¼€å§‹æ¸¸æˆ
2. è§¦å‘åå‡»
3. è§‚å¯Ÿç©å®¶å¤–è§‚

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç©å®¶å¤–è§‚æ— ä»»ä½•å˜åŒ–
- âœ… æ²¡æœ‰é—ªçƒæ•ˆæœ
- âœ… æ²¡æœ‰é¢œè‰²å˜åŒ–
- âœ… æ²¡æœ‰å…‰æ•ˆ

### æµ‹è¯•5ï¼šè°ƒè¯•æ¨¡å¼
1. åœ¨ `config.json` ä¸­å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š
   ```json
   "invincibility": {
     "debug": {
       "enabled": true,
       "showInConsole": true
     }
   }
   ```
2. å¼€å§‹æ¸¸æˆå¹¶è§¦å‘åå‡»
3. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¾“å‡º

**é¢„æœŸè¾“å‡º**ï¼š
```
Player invincible: counter, duration: 700ms
Player invincible: multi-counter, duration: 2400ms
```

---

## æ€§èƒ½å½±å“

### è®¡ç®—å¼€é”€
- `isPlayerInvincible()` æ¯å¸§è°ƒç”¨
- ç®€å•çš„å¸ƒå°”å€¼å’Œæ—¶é—´æˆ³æ¯”è¾ƒ
- æ€§èƒ½å¼€é”€ï¼š< 0.01ms
- **æ€»ä½“å½±å“ï¼šå¯å¿½ç•¥ä¸è®¡**

### å†…å­˜å¼€é”€
- æ–°å¢å˜é‡ï¼š
  - `playerInvincible` (boolean)
  - `invincibleEndTime` (number)
  - `invincibleReason` (string)
- **æ€»ä½“å½±å“ï¼šçº¦ 20 å­—èŠ‚ï¼Œå¯å¿½ç•¥ä¸è®¡**

---

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### æ”¹è¿›1ï¼šåå‡»æ›´å®‰å…¨
- âœ… åå‡»æœŸé—´å®Œå…¨å®‰å…¨
- âœ… å¯ä»¥æ”¾å¿ƒåå‡»
- âœ… é¼“åŠ±ä¸»åŠ¨è¿›æ”»

### æ”¹è¿›2ï¼šå®Œç¾æ ¼æŒ¡æ›´æœ‰ä»·å€¼
- âœ… å¤šé‡åå‡»å®Œå…¨å®‰å…¨
- âœ… é«˜éš¾åº¦æ“ä½œæœ‰ä¿éšœ
- âœ… æå‡ç©å®¶ç§¯ææ€§

### æ”¹è¿›3ï¼šæˆ˜æ–—æ›´æµç•…
- âœ… åå‡»åæœ‰ç¼“å†²æ—¶é—´
- âœ… æœ‰æ—¶é—´åšå‡ºååº”
- âœ… æˆ˜æ–—èŠ‚å¥æµç•…

---

## å¹³è¡¡æ€§è€ƒè™‘

### ä¸ä¼šè¿‡äºç®€å•
- âœ… åªåœ¨åå‡»æœŸé—´æ— æ•Œ
- âœ… ä¸å½±å“æ­£å¸¸æˆ˜æ–—
- âœ… ä¸èƒ½æ»¥ç”¨æ— æ•Œ
- âœ… ä»éœ€è¦æŠ€å·§å’Œæ—¶æœº

### é¼“åŠ±ä¸»åŠ¨è¿›æ”»
- âœ… è®©ç©å®¶æ•¢äºåå‡»
- âœ… å¥–åŠ±å®Œç¾æ ¼æŒ¡
- âœ… æå‡æˆ˜æ–—æµç•…åº¦
- âœ… ä¿æŒæŒ‘æˆ˜æ€§

---

## é…ç½®è°ƒæ•´å»ºè®®

å¦‚æœè§‰å¾—æ— æ•Œæ—¶é—´è¿‡é•¿æˆ–è¿‡çŸ­ï¼Œå¯ä»¥è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

### å•æ¬¡åå‡»
```json
"counter": {
  "duration": 500,      // åå‡»åŠ¨ç”»æ—¶é•¿
  "bufferTime": 200     // ç¼“å†²æ—¶é—´
}
```

**å»ºè®®èŒƒå›´**ï¼š
- duration: 400-600ms
- bufferTime: 100-300ms

### å¤šé‡åå‡»
```json
"multiCounter": {
  "perCounterDuration": 500,      // æ¯æ¬¡åå‡»æ—¶é•¿
  "delayBetweenCounters": 200,    // åå‡»é—´éš”
  "bufferTime": 300               // ç¼“å†²æ—¶é—´
}
```

**å»ºè®®èŒƒå›´**ï¼š
- perCounterDuration: 400-600ms
- delayBetweenCounters: 150-300ms
- bufferTime: 200-400ms

---

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. **game.js**
   - æ·»åŠ æ— æ•ŒçŠ¶æ€å˜é‡
   - å®ç°æ— æ•ŒçŠ¶æ€å‡½æ•°
   - é›†æˆåˆ°åå‡»ç³»ç»Ÿ
   - é›†æˆåˆ°ç¢°æ’æ£€æµ‹
   - æ·»åŠ æ¸¸æˆé‡ç½®æ¸…ç†

2. **config.json**
   - æ·»åŠ  `invincibility` é…ç½®èŠ‚
   - é…ç½®å•æ¬¡åå‡»å‚æ•°
   - é…ç½®å¤šé‡åå‡»å‚æ•°
   - é…ç½®è°ƒè¯•é€‰é¡¹

### æ–°å¢çš„æ–‡ä»¶
1. **INVINCIBILITY_IMPLEMENTATION_v3.7.md** (æœ¬æ–‡ä»¶)
   - å®ç°æ–‡æ¡£
   - ä½¿ç”¨è¯´æ˜
   - æµ‹è¯•æŒ‡å—

---

## ç›¸å…³æ–‡æ¡£

- [docs/gameplay/INVINCIBILITY_OPTIMIZATION_v3.7.md](docs/gameplay/INVINCIBILITY_OPTIMIZATION_v3.7.md) - è®¾è®¡æ–‡æ¡£
- [MULTI_COUNTER_IMPLEMENTATION_v3.4.md](MULTI_COUNTER_IMPLEMENTATION_v3.4.md) - å¤šé‡åå‡»å®ç°
- [config.json](config.json) - æ¸¸æˆé…ç½®

---

## ç‰ˆæœ¬ä¿¡æ¯

**ç‰ˆæœ¬**: v3.7  
**å®ç°æ—¥æœŸ**: 2024-12-19  
**çŠ¶æ€**: âœ… å®ç°å®Œæˆ

---

## æ€»ç»“

æˆ˜æ–—æ— æ•Œä¼˜åŒ– v3.7 å·²æˆåŠŸå®ç°ï¼

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… å•æ¬¡åå‡»æ— æ•Œï¼ˆ700msï¼‰
- âœ… å¤šé‡åå‡»æ— æ•Œï¼ˆåŠ¨æ€è®¡ç®—ï¼‰
- âœ… åå‡»åç¼“å†²æœŸä¿æŠ¤
- âœ… æ— è§†è§‰è¡¨ç°
- âœ… ç²¾ç¡®æ—¶é—´æ§åˆ¶
- âœ… å¯é…ç½®åŒ–
- âœ… è°ƒè¯•æ”¯æŒ

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âœ… åå‡»æ›´å®‰å…¨
- âœ… å®Œç¾æ ¼æŒ¡æ›´æœ‰ä»·å€¼
- âœ… æˆ˜æ–—æ›´æµç•…
- âœ… ä¿æŒæŒ‘æˆ˜æ€§

**æŠ€æœ¯å®ç°**ï¼š
- âœ… æ€§èƒ½å¼€é”€æå°
- âœ… ä»£ç ç®€æ´æ¸…æ™°
- âœ… æ˜“äºç»´æŠ¤å’Œè°ƒæ•´
- âœ… å®Œå…¨å‘åå…¼å®¹

ç°åœ¨å¯ä»¥å¼€å§‹æ¸¸æˆæµ‹è¯•æ–°åŠŸèƒ½äº†ï¼ğŸ®
